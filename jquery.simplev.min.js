// Copyright (c) 2018-2021 Alexander Kwaschny, kwaschny.net
(SimpleV=function(e,t){if(!(this instanceof SimpleV))return new SimpleV(e,t);var i,n,a,r=this;for(this._validationTypes=["email"],this._cache=[],this._cacheTracking=-1,this._groupNames={},this.validate=function(){for(var e=!0,t=null,i=r.form.getElementsByTagName("input"),n=i.length,a=0;a<n;a++)switch(i[a].type){case"text":case"password":case"search":if(!1===jQuery(i[a]).is(":visible")){!0===r.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[a]);continue}!1===r._validateText(i[a],!0)&&(null===t&&(t=i[a]),e=!1);break;case"checkbox":case"radio":if(!1===jQuery(i[a]).is(":visible")){!0===r.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[a]);continue}!1===r._validateDecision(i[a],!0)&&(null===t&&(t=i[a]),e=!1)}for(n=(i=r.form.getElementsByTagName("textarea")).length,a=0;a<n;a++)!1===jQuery(i[a]).is(":visible")?!0===r.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[a]):!1===r._validateText(i[a],!0)&&(null===t&&(t=i[a]),e=!1);for(n=(i=r.form.getElementsByTagName("select")).length,a=0;a<n;a++)!1===jQuery(i[a]).is(":visible")?!0===r.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[a]):!1===r._validateDecision(i[a])&&(null===t&&(t=i[a]),e=!1);return!1===e&&!0===r.options.scrollIntoView&&null!==t&&!1===r._isElementInViewport(t)&&(!0===r.options.log&&console.info("SimpleV: First element not passing validation is not visible in the current viewport. Scrolling into view...",t),r._scrollIntoView(t)),e},this.onValid=null,this.onInvalid=null,this._prepareElement=function(e){var t=e.getAttribute("data-v");if(null===t)return!1;if("string"==typeof e.name&&0<e.name.length){if("object"==typeof r._groupNames[e.name])return!0===r.options.log&&console.info('SimpleV: Element shares the "name" attribute with an already prepared element. Directives can only be declared once.',e),!1;r._groupNames[e.name]=e}if("string"!=typeof t||0===t.length)return!0===r.options.log&&console.warn("SimpleV: No directives found. Element will not be validated.",e),!1;var i,n=r._transformDirectives(t);if(null===n)return!0===r.options.log&&console.error("SimpleV: Invalid directives encountered. Element will not be validated.",e),!1;switch(n.max<1/0&&(e.maxLength=n.max),(n.element=e).type){case"checkbox":case"radio":0<e.name.length&&(i=e.tagName.toLowerCase(),n.groupedWith=r.form.querySelectorAll(i+'[name="'+e.name+'"]'))}return r._cacheDirectives(e,n),n},this._transformDirectives=function(e){if("string"!=typeof e)return null;for(var t={id:null,required:!1,type:null,min:-1/0,max:1/0,trim:!0,pattern:null,element:null,groupedWith:[],message:null,realtime:!1},i=e.split(","),n=i.length,a=0;a<n;a++){var l=i[a].trim();if("required"===l)t.required=!0;else if(/^(min|max)\s*[0-9]+$/.test(l)){var s=l.match(/^(min|max)\s*([0-9]+)$/);"min"===s[1]?t.min=parseInt(s[2],10):t.max=parseInt(s[2],10)}else if(/^\/.+\/$/.test(l)){s=l.substring(1,l.length-1),s=new RegExp(s);t.pattern=s}else if("notrim"===l)t.trim=!1;else{if(-1===r._validationTypes.indexOf(l))return null;t.type=l}}return t},this._cacheDirectives=function(e,t){var i=++r._cacheTracking;t.id=i,e.setAttribute("data-v-cached",i),r._cache[i]=t},this._validateText=function(e,t){var e=1===e.nodeType?e:e.target,i=e.getAttribute("data-v-cached");if(null!==i){var n=r._cache[i];if(!0===t)n.realtime=!0;else if(!1===n.realtime)return;var a,l,s,t=e.value,e=(t=!0===n.trim?t.trim():t).length,o=[];return n.required&&0===e&&o.push("INPUT_REQUIRED"),"email"===n.type&&(!0===n.required||0<e)&&(l=1<=(a=t.indexOf("@")),s=t.indexOf(".",a),l&&(2<=s-a&&s<e-1)||o.push("INPUT_EMAIL")),n.min>-1/0&&e<n.min&&o.push("INPUT_MIN"),n.max<1/0&&e>n.max&&o.push("INPUT_MAX"),null!==n.pattern&&(!0===n.required||0<e)&&!1===n.pattern.test(t)&&o.push("INPUT_PATTERN"),0<o.length?(r._showMessage(i,o),!1):(r._hideMessage(i),!0)}},this._registerTextValidation=function(e){var t=e.target;!0===t.autofocus&&(t.autofocus=!1,0===t.value.length)||r._validateText(e,!0)},this._validateDecision=function(e){var e=1===e.nodeType?e:e.target,t=e.getAttribute("data-v-cached");if(null!==t){var i,n,a=r._cache[t],l=[],s=a.groupedWith.length;if(a.required)if("SELECT"===e.tagName)""===e.value&&l.push("SELECTION_REQUIRED");else{var o=!1;if(0<s){for(i=0;i<s;i++)if(!0===a.groupedWith[i].checked){o=!0;break}}else o=e.checked;!1===o&&l.push("SELECTION_REQUIRED")}if(a.min>-1/0&&0<s){for(i=n=0;i<s;i++)!0===a.groupedWith[i].checked&&n++;n<a.min&&l.push("SELECTION_MIN")}if(a.max<1/0&&0<s){for(i=n=0;i<s;i++)!0===a.groupedWith[i].checked&&n++;n>a.max&&l.push("SELECTION_MAX")}return 0<l.length?(r._showMessage(t,l),!1):(r._hideMessage(t),!0)}},this._registerDecisionValidation=function(e){r._validateDecision(e)},this._createMessage=function(e){var t=document.createElement("div");if(t.className=r.options.className,"function"==typeof r.options.position)r.options.position(t,e);else switch(r.options.position){case"append":e.parentElement.appendChild(t);break;case"prepend":e.parentElement.insertBefore(t,e);break;default:throw new Error('SimpleV: Invalid option value encountered for "position". The value "'+r.options.position+'" is not supported.')}return t},this._showMessage=function(e,t){if(0!==t.length){var i=r._cache[e],n=i.groupedWith.length;if(0<n)for(var a=0<=t.indexOf("SELECTION_MIN"),l=0;l<n;l++)a&&!0===i.groupedWith[l].checked?(i.groupedWith[l].classList.remove(r.options.invalidClass),i.groupedWith[l].classList.add(r.options.validClass)):(i.groupedWith[l].classList.remove(r.options.validClass),i.groupedWith[l].classList.add(r.options.invalidClass));else i.element.classList.remove(r.options.validClass),i.element.classList.add(r.options.invalidClass);null===i.message&&(i.message=r._createMessage(i.element));e=t[0];if("string"!=typeof SimpleV.l10n[e])throw new Error("SimpleV: Missing localization entry in SimpleV.l10n for reason: "+e);t=i.element.getAttribute("data-v-msg"),t="string"==typeof t&&0<t.length?t:SimpleV.l10n[e];t=(t=t.replace(/\{min\}/g,i.min)).replace(/\{max\}/g,i.max),i.message.innerHTML=t,i.message.removeAttribute("hidden")}},this._hideMessage=function(e){var t=r._cache[e],i=t.groupedWith.length;if(0<i)for(var n=0;n<i;n++)t.groupedWith[n].classList.remove(r.options.invalidClass),t.groupedWith[n].classList.add(r.options.validClass);else t.element.classList.remove(r.options.invalidClass),t.element.classList.add(r.options.validClass);null!==t.message&&(t.message.setAttribute("hidden",""),t.message.innerHTML="")},this._isElementInViewport=function(e){e=e.getBoundingClientRect();return 0<=e.top&&0<=e.left&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth},this._scrollIntoView=function(e){jQuery("html, body").animate({scrollTop:jQuery(e).offset().top+r.options.scrollIntoViewOffset},r.options.scrollIntoViewDuration)},this.defaultOptions={delayValidation:!0,scrollIntoView:!0,scrollIntoViewDuration:600,scrollIntoViewOffset:-32,position:"append",className:"simplev-message",validClass:"simplev-valid",invalidClass:"simplev-invalid",log:!1},this.options=jQuery.extend({},this.defaultOptions,t),this.form=e,this.form.addEventListener("submit",function(e){var t=r.validate()?"function"!=typeof r.onValid||r.onValid(r):"function"==typeof r.onInvalid&&r.onInvalid(r);return!1===t&&e.preventDefault(),t}),n=(i=this.form.getElementsByTagName("input")).length,a=0;a<n;a++)switch(i[a].type){case"text":case"password":case"search":if(!1===this._prepareElement(i[a]))continue;i[a].addEventListener("input",r._validateText),i[a].addEventListener("blur",r._registerTextValidation);break;case"checkbox":case"radio":var l=this._prepareElement(i[a]);if(!1===l)continue;var s=l.groupedWith.length;if(0<s)for(var o=0;o<s;o++)l.groupedWith[o].setAttribute("data-v-cached",l.id),l.groupedWith[o].addEventListener("change",r._validateDecision);else i[a].addEventListener("change",r._validateDecision)}for(n=(i=this.form.getElementsByTagName("textarea")).length,a=0;a<n;a++)!1!==this._prepareElement(i[a])&&i[a].addEventListener("input",r._validateText);for(n=(i=this.form.getElementsByTagName("select")).length,a=0;a<n;a++)!1!==this._prepareElement(i[a])&&i[a].addEventListener("change",r._validateDecision)}).l10n={INPUT_REQUIRED:"This field is required.",INPUT_MIN:"This field must contain at least {min} characters.",INPUT_MAX:"This field must not exceed a total number of {max} characters.",INPUT_PATTERN:"This field does not match the expected pattern.",INPUT_EMAIL:"This field is not a valid e-mail address.",SELECTION_REQUIRED:"Selection is required.",SELECTION_MIN:"Select at least {min} options.",SELECTION_MAX:"Select no more than {max} options."},SimpleV.forms=[],SimpleV.form=null,SimpleV.init=function(e,t){if("object"==typeof e&&null!==e)1!==e.nodeType&&(t=e,e=void 0);else if("string"==typeof e)e=document.querySelector(e);else if(void 0!==e)throw new Error("SimpleV: Invalid arguments encountered for function: init");for(var i,n=(i="FORM"===(e=void 0===e?document.body:e).tagName?[e]:e.querySelectorAll("form[data-v]")).length,a=0;a<n;a++)i[a].hasAttribute("data-v-cached")?void 0!==t&&!0===t.log&&console.warn("SimpleV: Form already initialized.",i[a]):"false"===i[a].getAttribute("data-v")?void 0!==t&&!0===t.log&&console.warn("SimpleV: Form explicitly skipped.",i[a]):(i[a].setAttribute("data-v-cached",SimpleV.forms.length),SimpleV.forms.push(new SimpleV(i[a],t)),1===SimpleV.forms.length&&(SimpleV.form=SimpleV.forms[0]))},SimpleV.isValid=function(e){if("object"==typeof(e=window.jQuery&&e instanceof jQuery?e[0]:e)&&null!==e&&1===e.nodeType){SimpleV.init(e);for(var t=0;t<SimpleV.forms.length;t++)if(SimpleV.forms[t].form===e)return SimpleV.forms[t].validate();return!1}SimpleV.init();for(t=0;t<SimpleV.forms.length;t++)if(!SimpleV.forms[t].validate())return!1;return!0},SimpleV.version="0.2.1";
