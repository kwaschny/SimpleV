// Copyright (c) 2018 Alexander Kwaschny, kwaschny.net
SimpleV=function(form,options){if(!(this instanceof SimpleV)){return new SimpleV(form,options)}var self=this;this._validationTypes=["email"];this._cache=[];this._cacheTracking=-1;this._groupNames={};this.validate=function(){var result=true;var elements,elementCount,i;var firstElementWithReason=null;elements=self.form.getElementsByTagName("input");elementCount=elements.length;for(i=0;i<elementCount;i++){switch(elements[i].type){case"text":case"password":case"search":if(jQuery(elements[i]).is(":visible")===false){if(self.options.log===true){console.warn("SimpleV: Element not visible. Element will not be validated.",elements[i])}continue}if(self._validateText(elements[i],true)===false){if(firstElementWithReason===null){firstElementWithReason=elements[i]}result=false}break;case"checkbox":case"radio":if(jQuery(elements[i]).is(":visible")===false){if(self.options.log===true){console.warn("SimpleV: Element not visible. Element will not be validated.",elements[i])}continue}if(self._validateDecision(elements[i],true)===false){if(firstElementWithReason===null){firstElementWithReason=elements[i]}result=false}break}}elements=self.form.getElementsByTagName("textarea");elementCount=elements.length;for(i=0;i<elementCount;i++){if(jQuery(elements[i]).is(":visible")===false){if(self.options.log===true){console.warn("SimpleV: Element not visible. Element will not be validated.",elements[i])}continue}if(self._validateText(elements[i],true)===false){if(firstElementWithReason===null){firstElementWithReason=elements[i]}result=false}}elements=self.form.getElementsByTagName("select");elementCount=elements.length;for(i=0;i<elementCount;i++){if(jQuery(elements[i]).is(":visible")===false){if(self.options.log===true){console.warn("SimpleV: Element not visible. Element will not be validated.",elements[i])}continue}if(self._validateDecision(elements[i])===false){if(firstElementWithReason===null){firstElementWithReason=elements[i]}result=false}}if(result===false&&self.options.scrollIntoView===true){if(firstElementWithReason!==null&&self._isElementInViewport(firstElementWithReason)===false){if(self.options.log===true){console.info("SimpleV: First element not passing validation is not visible in the current viewport. Scrolling into view...",firstElementWithReason)}self._scrollIntoView(firstElementWithReason)}}return result};this.onValid=null;this.onInvalid=null;this._prepareElement=function(element){var plainDir=element.getAttribute("data-v");if(plainDir===null){return false}if(typeof element.name==="string"&&element.name.length>0){if(typeof self._groupNames[element.name]!=="object"){self._groupNames[element.name]=element}else{if(self.options.log===true){console.info('SimpleV: Element shares the "name" attribute with an already prepared element. Directives can only be declared once.',element)}return false}}if(typeof plainDir!=="string"||plainDir.length===0){if(self.options.log===true){console.warn("SimpleV: No directives found. Element will not be validated.",element)}return false}var dir=self._transformDirectives(plainDir);if(dir===null){if(self.options.log===true){console.error("SimpleV: Invalid directives encountered. Element will not be validated.",element)}return false}if(dir.max<Infinity){element.maxLength=dir.max}dir.element=element;switch(element.type){case"checkbox":case"radio":if(element.name.length>0){var tagSelector=element.tagName.toLowerCase();dir.groupedWith=self.form.querySelectorAll(tagSelector+'[name="'+element.name+'"]')}break}self._cacheDirectives(element,dir);return dir};this._transformDirectives=function(plainDir){if(typeof plainDir!=="string"){return null}var result={id:null,required:false,type:null,min:-Infinity,max:Infinity,trim:true,pattern:null,element:null,groupedWith:[],message:null,realtime:false};var params=plainDir.split(",");var paramCount=params.length;for(var i=0;i<paramCount;i++){var param=params[i].trim();if(param==="required"){result.required=true}else if(/^(min|max)\s*[0-9]+$/.test(param)){var parts=param.match(/^(min|max)\s*([0-9]+)$/);if(parts[1]==="min"){result.min=parseInt(parts[2],10)}else{result.max=parseInt(parts[2],10)}}else if(/^\/.+\/$/.test(param)){var re=param.substring(1,param.length-1);re=new RegExp(re);result.pattern=re}else if(param==="notrim"){result.trim=false}else{if(self._validationTypes.indexOf(param)===-1){return null}result.type=param}}return result};this._cacheDirectives=function(element,directives){var trackingIndex=++self._cacheTracking;directives.id=trackingIndex;element.setAttribute("data-v-cached",trackingIndex);self._cache[trackingIndex]=directives};this._validateText=function(e,registerForRT){var element=e.nodeType===1?e:e.target;var dirIndex=element.getAttribute("data-v-cached");if(dirIndex===null){return}var dir=self._cache[dirIndex];if(registerForRT===true){dir.realtime=true}else if(dir.realtime===false){return}var text=element.value;if(dir.trim===true){text=text.trim()}var textLength=text.length;var reasons=[];if(dir.required&&textLength===0){reasons.push("INPUT_REQUIRED")}switch(dir.type){case"email":if(dir.required===true||textLength>0){var posAt=text.indexOf("@");var hasAt=posAt>=1;var posDot=text.indexOf(".",posAt);var hasDot=posDot-posAt>=2&&posDot<textLength-1;if(!hasAt||!hasDot){reasons.push("INPUT_EMAIL")}}break}if(dir.min>-Infinity&&textLength<dir.min){reasons.push("INPUT_MIN")}if(dir.max<Infinity&&textLength>dir.max){reasons.push("INPUT_MAX")}if(dir.pattern!==null){if(dir.required===true||textLength>0){if(dir.pattern.test(text)===false){reasons.push("INPUT_PATTERN")}}}if(reasons.length>0){self._showMessage(dirIndex,reasons);return false}else{self._hideMessage(dirIndex);return true}};this._registerTextValidation=function(event){var element=event.target;if(element.autofocus===true){element.autofocus=false;if(element.value.length===0){return}}self._validateText(event,true)};this._validateDecision=function(e){var element=e.nodeType===1?e:e.target;var dirIndex=element.getAttribute("data-v-cached");if(dirIndex===null){return}var dir=self._cache[dirIndex];var reasons=[];var i,checkedCount,groupCount=dir.groupedWith.length;if(dir.required){if(element.tagName==="SELECT"){if(element.value===""){reasons.push("SELECTION_REQUIRED")}}else{var checked=false;if(groupCount>0){for(i=0;i<groupCount;i++){if(dir.groupedWith[i].checked===true){checked=true;break}}}else{checked=element.checked}if(checked===false){reasons.push("SELECTION_REQUIRED")}}}if(dir.min>-Infinity&&groupCount>0){checkedCount=0;for(i=0;i<groupCount;i++){if(dir.groupedWith[i].checked===true){checkedCount++}}if(checkedCount<dir.min){reasons.push("SELECTION_MIN")}}if(dir.max<Infinity&&groupCount>0){checkedCount=0;for(i=0;i<groupCount;i++){if(dir.groupedWith[i].checked===true){checkedCount++}}if(checkedCount>dir.max){reasons.push("SELECTION_MAX")}}if(reasons.length>0){self._showMessage(dirIndex,reasons);return false}else{self._hideMessage(dirIndex);return true}};this._registerDecisionValidation=function(e){self._validateDecision(e)};this._getMessagePosition=function(element){var $element=jQuery(element);var position=$element.position();var width=$element.outerWidth();var height=$element.outerHeight();switch(self.options.position){case"top":return{top:position.top-Math.min(height,21)-self.options.offsetY,left:position.left+self.options.offsetX};case"right":return{top:position.top+self.options.offsetY,left:position.left+width+self.options.offsetX};case"bottom":return{top:position.top+height+self.options.offsetY,left:position.left+self.options.offsetX};default:throw new Error('SimpleV: Invalid option value encountered for "position". The value "'+self.options.position+'" is not supported.')}};this._createMessage=function(element){var message=document.createElement("div");message.className=self.options.className;if(self.options.display==="relative"){var position=self._getMessagePosition(element);message.style.position="absolute";message.style.top=position.top+"px";message.style.left=position.left+"px"}else{message.style.display="inline-block"}element.parentElement.appendChild(message);return message};this._showMessage=function(index,reasons){var dir=self._cache[index];var groupCount=dir.groupedWith.length;if(groupCount>0){var minNotReached=reasons.indexOf("SELECTION_MIN")>=0;for(var i=0;i<groupCount;i++){if(minNotReached&&dir.groupedWith[i].checked===true){dir.groupedWith[i].classList.remove(self.options.invalidClass);dir.groupedWith[i].classList.add(self.options.validClass)}else{dir.groupedWith[i].classList.remove(self.options.validClass);dir.groupedWith[i].classList.add(self.options.invalidClass)}}}else{dir.element.classList.remove(self.options.validClass);dir.element.classList.add(self.options.invalidClass)}if(dir.message===null){dir.message=self._createMessage(dir.element)}var reason=reasons[0];if(typeof SimpleV.l10n[reason]==="string"){var messageText;var custom=dir.element.getAttribute("data-v-msg");if(typeof custom==="string"&&custom.length>0){messageText=custom}else{messageText=SimpleV.l10n[reason]}messageText=messageText.replace(/\{min\}/g,dir.min);messageText=messageText.replace(/\{max\}/g,dir.max);dir.message.innerHTML=messageText}else{throw new Error("SimpleV: Missing localization entry in SimpleV.l10n for reason: "+reason)}dir.message.style.removeProperty("display")};this._hideMessage=function(index){var dir=self._cache[index];var groupCount=dir.groupedWith.length;if(groupCount>0){for(var i=0;i<groupCount;i++){dir.groupedWith[i].classList.remove(self.options.invalidClass);dir.groupedWith[i].classList.add(self.options.validClass)}}else{dir.element.classList.remove(self.options.invalidClass);dir.element.classList.add(self.options.validClass)}if(dir.message!==null){dir.message.style.display="none";dir.message.innerHTML=""}};this._isElementInViewport=function(element){var rect=element.getBoundingClientRect();return rect.top>=0&&rect.left>=0&&rect.bottom<=window.innerHeight&&rect.right<=window.innerWidth};this._scrollIntoView=function(element){jQuery("html, body").animate({scrollTop:jQuery(element).offset().top+self.options.scrollIntoViewOffset},self.options.scrollIntoViewDuration)};this.defaultOptions={delayValidation:true,scrollIntoView:true,scrollIntoViewDuration:600,scrollIntoViewOffset:-32,display:"static",position:"top",offsetX:null,offsetY:null,className:"simplev-message",validClass:"simplev-valid",invalidClass:"simplev-invalid",log:false};this.options=jQuery.extend({},this.defaultOptions,options);this.form=form;if(this.options.display==="relative"){this.form.style.position="relative"}this.form.addEventListener("submit",function(event){var result;if(self.validate()){if(typeof self.onValid=="function"){result=self.onValid(self)}else{result=true}}else{if(typeof self.onInvalid=="function"){result=self.onInvalid(self)}else{result=false}}if(result===false){event.preventDefault()}return result});var elements,elementCount,i;elements=this.form.getElementsByTagName("input");elementCount=elements.length;for(i=0;i<elementCount;i++){switch(elements[i].type){case"text":case"password":case"search":if(this._prepareElement(elements[i])===false){continue}elements[i].addEventListener("input",self._validateText);elements[i].addEventListener("blur",self._registerTextValidation);break;case"checkbox":case"radio":var dir=this._prepareElement(elements[i]);if(dir===false){continue}var groupCount=dir.groupedWith.length;if(groupCount>0){for(i=0;i<groupCount;i++){dir.groupedWith[i].setAttribute("data-v-cached",dir.id);dir.groupedWith[i].addEventListener("change",self._validateDecision)}}else{elements[i].addEventListener("change",self._validateDecision)}break}}elements=this.form.getElementsByTagName("textarea");elementCount=elements.length;for(i=0;i<elementCount;i++){if(this._prepareElement(elements[i])===false){continue}elements[i].addEventListener("input",self._validateText)}elements=this.form.getElementsByTagName("select");elementCount=elements.length;for(i=0;i<elementCount;i++){if(this._prepareElement(elements[i])===false){continue}elements[i].addEventListener("change",self._validateDecision)}};SimpleV.l10n={INPUT_REQUIRED:"This field is required.",INPUT_MIN:"This field must contain at least {min} characters.",INPUT_MAX:"This field must not exceed a total number of {max} characters.",INPUT_PATTERN:"This field does not match the expected pattern.",INPUT_EMAIL:"This field is not a valid e-mail address.",SELECTION_REQUIRED:"Selection is required.",SELECTION_MIN:"Select at least {min} options.",SELECTION_MAX:"Select no more than {max} options."};SimpleV.forms=[];SimpleV.form=null;SimpleV.init=function(body,options){if(typeof body==="object"){if(body.nodeType!==1){options=body;body=undefined}}else if(typeof body==="string"){body=document.querySelector(body)}else if(body!==undefined){throw new Error("SimpleV: Invalid arguments encountered for function: init")}if(body===undefined){body=document.body}var forms;if(body.tagName==="FORM"){forms=[body]}else{forms=body.querySelectorAll("form[data-v]")}var formsCount=forms.length;for(var i=0;i<formsCount;i++){if(forms[i].hasAttribute("data-v-cached")){if(options!==undefined&&options.log===true){console.warn("SimpleV: Form already initialized.",forms[i])}continue}var enabled=forms[i].getAttribute("data-v");if(enabled==="false"){if(options!==undefined&&options.log===true){console.warn("SimpleV: Form explicitly skipped.",forms[i])}continue}forms[i].setAttribute("data-v-cached",SimpleV.forms.length);SimpleV.forms.push(new SimpleV(forms[i],options));if(SimpleV.forms.length===1){SimpleV.form=SimpleV.forms[0]}}};SimpleV.isValid=function(form){for(var i=0;i<SimpleV.forms.length;i++){if(SimpleV.forms[i].form===form){return SimpleV.forms[i].validate()}}return false};SimpleV.version="0.1.2";