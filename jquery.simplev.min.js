// Copyright (c) 2018-2021 Alexander Kwaschny, kwaschny.net
SimpleV=function(e,t){if(!(this instanceof SimpleV))return new SimpleV(e,t);var i,n,s,m=this;for(this._validationTypes=["email"],this._cache=[],this._cacheTracking=-1,this._groupNames={},this.validate=function(){for(var e=!0,t=null,i=m.form.getElementsByTagName("input"),n=i.length,s=0;s<n;s++)switch(i[s].type){case"text":case"password":case"search":if(!1===jQuery(i[s]).is(":visible")){!0===m.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[s]);continue}!1===m._validateText(i[s],!0)&&(null===t&&(t=i[s]),e=!1);break;case"checkbox":case"radio":if(!1===jQuery(i[s]).is(":visible")){!0===m.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[s]);continue}!1===m._validateDecision(i[s],!0)&&(null===t&&(t=i[s]),e=!1)}for(n=(i=m.form.getElementsByTagName("textarea")).length,s=0;s<n;s++)!1!==jQuery(i[s]).is(":visible")?!1===m._validateText(i[s],!0)&&(null===t&&(t=i[s]),e=!1):!0===m.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[s]);for(n=(i=m.form.getElementsByTagName("select")).length,s=0;s<n;s++)!1!==jQuery(i[s]).is(":visible")?!1===m._validateDecision(i[s])&&(null===t&&(t=i[s]),e=!1):!0===m.options.log&&console.warn("SimpleV: Element not visible. Element will not be validated.",i[s]);return!1===e&&!0===m.options.scrollIntoView&&null!==t&&!1===m._isElementInViewport(t)&&(!0===m.options.log&&console.info("SimpleV: First element not passing validation is not visible in the current viewport. Scrolling into view...",t),m._scrollIntoView(t)),e},this.onValid=null,this.onInvalid=null,this._prepareElement=function(e){var t=e.getAttribute("data-v");if(null===t)return!1;if("string"==typeof e.name&&0<e.name.length){if("object"==typeof m._groupNames[e.name])return!0===m.options.log&&console.info('SimpleV: Element shares the "name" attribute with an already prepared element. Directives can only be declared once.',e),!1;m._groupNames[e.name]=e}if("string"!=typeof t||0===t.length)return!0===m.options.log&&console.warn("SimpleV: No directives found. Element will not be validated.",e),!1;var i,n=m._transformDirectives(t);if(null===n)return!0===m.options.log&&console.error("SimpleV: Invalid directives encountered. Element will not be validated.",e),!1;switch(n.max<1/0&&(e.maxLength=n.max),(n.element=e).type){case"checkbox":case"radio":0<e.name.length&&(i=e.tagName.toLowerCase(),n.groupedWith=m.form.querySelectorAll(i+'[name="'+e.name+'"]'))}return m._cacheDirectives(e,n),n},this._transformDirectives=function(e){if("string"!=typeof e)return null;for(var t={id:null,required:!1,type:null,min:-1/0,max:1/0,trim:!0,pattern:null,element:null,groupedWith:[],message:null,realtime:!1},i=e.split(","),n=i.length,s=0;s<n;s++){var a=i[s].trim();if("required"===a)t.required=!0;else if(/^(min|max)\s*[0-9]+$/.test(a)){var o=a.match(/^(min|max)\s*([0-9]+)$/);"min"===o[1]?t.min=parseInt(o[2],10):t.max=parseInt(o[2],10)}else if(/^\/.+\/$/.test(a)){var l=a.substring(1,a.length-1),l=new RegExp(l);t.pattern=l}else if("notrim"===a)t.trim=!1;else{if(-1===m._validationTypes.indexOf(a))return null;t.type=a}}return t},this._cacheDirectives=function(e,t){var i=++m._cacheTracking;t.id=i,e.setAttribute("data-v-cached",i),m._cache[i]=t},this._validateText=function(e,t){var i=1===e.nodeType?e:e.target,n=i.getAttribute("data-v-cached");if(null!==n){var s=m._cache[n];if(!0===t)s.realtime=!0;else if(!1===s.realtime)return;var a=i.value;!0===s.trim&&(a=a.trim());var o,l,r,d=a.length,p=[];switch(s.required&&0===d&&p.push("INPUT_REQUIRED"),s.type){case"email":(!0===s.required||0<d)&&(l=1<=(o=a.indexOf("@")),r=a.indexOf(".",o),l&&(2<=r-o&&r<d-1)||p.push("INPUT_EMAIL"))}return s.min>-1/0&&d<s.min&&p.push("INPUT_MIN"),s.max<1/0&&d>s.max&&p.push("INPUT_MAX"),null!==s.pattern&&(!0===s.required||0<d)&&!1===s.pattern.test(a)&&p.push("INPUT_PATTERN"),0<p.length?(m._showMessage(n,p),!1):(m._hideMessage(n),!0)}},this._registerTextValidation=function(e){var t=e.target;!0===t.autofocus&&(t.autofocus=!1,0===t.value.length)||m._validateText(e,!0)},this._validateDecision=function(e){var t=1===e.nodeType?e:e.target,i=t.getAttribute("data-v-cached");if(null!==i){var n,s,a=m._cache[i],o=[],l=a.groupedWith.length;if(a.required)if("SELECT"===t.tagName)""===t.value&&o.push("SELECTION_REQUIRED");else{var r=!1;if(0<l){for(n=0;n<l;n++)if(!0===a.groupedWith[n].checked){r=!0;break}}else r=t.checked;!1===r&&o.push("SELECTION_REQUIRED")}if(a.min>-1/0&&0<l){for(n=s=0;n<l;n++)!0===a.groupedWith[n].checked&&s++;s<a.min&&o.push("SELECTION_MIN")}if(a.max<1/0&&0<l){for(n=s=0;n<l;n++)!0===a.groupedWith[n].checked&&s++;s>a.max&&o.push("SELECTION_MAX")}return 0<o.length?(m._showMessage(i,o),!1):(m._hideMessage(i),!0)}},this._registerDecisionValidation=function(e){m._validateDecision(e)},this._getMessagePosition=function(e){var t=jQuery(e),i=t.position(),n=t.outerWidth(),s=t.outerHeight();switch(m.options.position){case"top":return{top:i.top-Math.min(s,21)-m.options.offsetY,left:i.left+m.options.offsetX};case"right":return{top:i.top+m.options.offsetY,left:i.left+n+m.options.offsetX};case"bottom":return{top:i.top+s+m.options.offsetY,left:i.left+m.options.offsetX};default:throw new Error('SimpleV: Invalid option value encountered for "position". The value "'+m.options.position+'" is not supported.')}},this._createMessage=function(e){var t,i=document.createElement("div");return i.className=m.options.className,"relative"===m.options.display?(t=m._getMessagePosition(e),i.style.position="absolute",i.style.top=t.top+"px",i.style.left=t.left+"px"):i.style.display="inline-block",e.parentElement.appendChild(i),i},this._showMessage=function(e,t){var i=m._cache[e],n=i.groupedWith.length;if(0<n)for(var s=0<=t.indexOf("SELECTION_MIN"),a=0;a<n;a++)s&&!0===i.groupedWith[a].checked?(i.groupedWith[a].classList.remove(m.options.invalidClass),i.groupedWith[a].classList.add(m.options.validClass)):(i.groupedWith[a].classList.remove(m.options.validClass),i.groupedWith[a].classList.add(m.options.invalidClass));else i.element.classList.remove(m.options.validClass),i.element.classList.add(m.options.invalidClass);null===i.message&&(i.message=m._createMessage(i.element));var o=t[0];if("string"!=typeof SimpleV.l10n[o])throw new Error("SimpleV: Missing localization entry in SimpleV.l10n for reason: "+o);var l=i.element.getAttribute("data-v-msg"),r="string"==typeof l&&0<l.length?l:SimpleV.l10n[o];r=(r=r.replace(/\{min\}/g,i.min)).replace(/\{max\}/g,i.max),i.message.innerHTML=r,i.message.style.removeProperty("display")},this._hideMessage=function(e){var t=m._cache[e],i=t.groupedWith.length;if(0<i)for(var n=0;n<i;n++)t.groupedWith[n].classList.remove(m.options.invalidClass),t.groupedWith[n].classList.add(m.options.validClass);else t.element.classList.remove(m.options.invalidClass),t.element.classList.add(m.options.validClass);null!==t.message&&(t.message.style.display="none",t.message.innerHTML="")},this._isElementInViewport=function(e){var t=e.getBoundingClientRect();return 0<=t.top&&0<=t.left&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth},this._scrollIntoView=function(e){jQuery("html, body").animate({scrollTop:jQuery(e).offset().top+m.options.scrollIntoViewOffset},m.options.scrollIntoViewDuration)},this.defaultOptions={delayValidation:!0,scrollIntoView:!0,scrollIntoViewDuration:600,scrollIntoViewOffset:-32,display:"static",position:"top",offsetX:null,offsetY:null,className:"simplev-message",validClass:"simplev-valid",invalidClass:"simplev-invalid",log:!1},this.options=jQuery.extend({},this.defaultOptions,t),this.form=e,"relative"===this.options.display&&(this.form.style.position="relative"),this.form.addEventListener("submit",function(e){var t=m.validate()?"function"!=typeof m.onValid||m.onValid(m):"function"==typeof m.onInvalid&&m.onInvalid(m);return!1===t&&e.preventDefault(),t}),n=(i=this.form.getElementsByTagName("input")).length,s=0;s<n;s++)switch(i[s].type){case"text":case"password":case"search":if(!1===this._prepareElement(i[s]))continue;i[s].addEventListener("input",m._validateText),i[s].addEventListener("blur",m._registerTextValidation);break;case"checkbox":case"radio":var a=this._prepareElement(i[s]);if(!1===a)continue;var o=a.groupedWith.length;if(0<o)for(var l=0;l<o;l++)a.groupedWith[l].setAttribute("data-v-cached",a.id),a.groupedWith[l].addEventListener("change",m._validateDecision);else i[s].addEventListener("change",m._validateDecision)}for(n=(i=this.form.getElementsByTagName("textarea")).length,s=0;s<n;s++)!1!==this._prepareElement(i[s])&&i[s].addEventListener("input",m._validateText);for(n=(i=this.form.getElementsByTagName("select")).length,s=0;s<n;s++)!1!==this._prepareElement(i[s])&&i[s].addEventListener("change",m._validateDecision)},SimpleV.l10n={INPUT_REQUIRED:"This field is required.",INPUT_MIN:"This field must contain at least {min} characters.",INPUT_MAX:"This field must not exceed a total number of {max} characters.",INPUT_PATTERN:"This field does not match the expected pattern.",INPUT_EMAIL:"This field is not a valid e-mail address.",SELECTION_REQUIRED:"Selection is required.",SELECTION_MIN:"Select at least {min} options.",SELECTION_MAX:"Select no more than {max} options."},SimpleV.forms=[],SimpleV.form=null,SimpleV.init=function(e,t){if("object"==typeof e)1!==e.nodeType&&(t=e,e=void 0);else if("string"==typeof e)e=document.querySelector(e);else if(void 0!==e)throw new Error("SimpleV: Invalid arguments encountered for function: init");var i;void 0===e&&(e=document.body);for(var n=(i="FORM"===e.tagName?[e]:e.querySelectorAll("form[data-v]")).length,s=0;s<n;s++){i[s].hasAttribute("data-v-cached")?void 0!==t&&!0===t.log&&console.warn("SimpleV: Form already initialized.",i[s]):"false"!==i[s].getAttribute("data-v")?(i[s].setAttribute("data-v-cached",SimpleV.forms.length),SimpleV.forms.push(new SimpleV(i[s],t)),1===SimpleV.forms.length&&(SimpleV.form=SimpleV.forms[0])):void 0!==t&&!0===t.log&&console.warn("SimpleV: Form explicitly skipped.",i[s])}},SimpleV.isValid=function(e){SimpleV.init(e);for(var t=0;t<SimpleV.forms.length;t++)if(SimpleV.forms[t].form===e)return SimpleV.forms[t].validate();return!1},SimpleV.version="0.1.4";